<%= form_with(model: [:admin, article]) do |form| %>
  <% disabled = (article.status == "waiting_for_review") %>
  <% if article.errors.any? %>
    <div class="text-red-600 mb-4">
      <h2 class="font-semibold mb-2"><%= pluralize(article.errors.count, "error") %> prohibited this admin_article from being saved:</h2>
      <ul class="list-disc list-inside">
        <% article.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  
  <%= form.fields_for :content do |content_form|%>
    <div class="form-control">
      <%= content_form.label :title, class: "label" %>
      <%= content_form.text_field :title, class: "input input-bordered w-full focus:outline-none focus:ring-2 focus:ring-gray-100 focus:ring-opacity-50" %>
    </div>
  <%end %>

  <div class="form-control">
    <%= form.label :description, class: "label" %>
    <%= form.text_area :description, class: "textarea textarea-bordered w-full h-24 resize-y focus:outline-none focus:ring-2 focus:ring-gray-100 focus:ring-opacity-50", disabled: disabled %>
  </div>

  <!-- Cover Image Upload Section -->
  <div class="form-control mb-4">
    <%= form.label :cover_image, class: "label" %>
    
    <!-- Upload Area -->
    <label for="article_cover_image" class="cursor-pointer">
      <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
        <div class="space-y-2">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <div class="text-gray-600">
            
              <span class="font-medium text-blue-600 hover:text-blue-500">Click to upload</span>
            
            <p class="text-xs text-gray-500">PNG, JPG, GIF</p>
          </div>
          <%= form.file_field :cover_image, 
              class: "hidden", 
              accept: "image/*",
              disabled: disabled,
              onchange: "previewImage(this)" %>
        </div>
      </div>
    </label>
  
    <!-- Image Preview -->
    <div id="image-preview" class="hidden mt-4">
      <div class="relative">
        <img id="preview-img" class="w-full h-64 object-cover rounded-lg border border-gray-200" alt="Preview">
        <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors" onclick="removeImage()">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  
    <!-- Current Image Display -->
    <% if article.cover_image.present? %>
      <div class="mt-4">
        <label class="label">Current Cover Image:</label>
        <div class="relative">
          <%= image_tag article.cover_image, alt: "Current cover image", class: "w-full h-64 object-cover rounded-lg border border-gray-200" %>
        </div>
      </div>
    <% end %>
  </div>

  <div>
    <div class="flex justify-end">
      <% if article.status == "waiting_for_review" %>
        <%= hidden_field_tag "article[status]", "waiting_for_review" %>
        <%= button_tag "Reject", type: "submit", name: "article[status]", value: "draft", class: "bg-red-600  mr-2 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded" %>

        <%= button_tag "Approve", type: "submit", name: "article[status]", value: "published", class: "bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded" %>
      <% else %>
        <%= button_tag "Save as Draft", type: "submit", name: "article[status]", value: "draft", class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded mr-2" %>
        <%= button_tag "Submit for Review", type: "submit", name: "article[status]", value: "waiting_for_review", class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded" %>
      <% end %>
    </div>
  </div>
<% end %>

<script>
function previewImage(input) {
  console.log("previewImage called!");
  const file = input.files[0];
  const preview = document.getElementById('image-preview');
  const previewImg = document.getElementById('preview-img');
  const uploadArea = document.getElementById('upload-area');

  console.log("File:", file);
  console.log("Preview element:", preview);
  console.log("Preview img element:", previewImg);
  console.log("Upload area:", uploadArea);

  if (file && preview && previewImg && uploadArea) {
    const reader = new FileReader();
    reader.onload = function(e) {
      console.log("File loaded!");
      previewImg.src = e.target.result;
      preview.classList.remove('hidden');
      uploadArea.classList.add('hidden'); // Hide the upload area
    };
    reader.onerror = function(e) {
      console.error("Error reading file:", e);
    };
    reader.readAsDataURL(file);
  } else {
    console.error("Missing elements:", { file, preview, previewImg, uploadArea });
  }
}

function removeImage() {
  console.log("removeImage called!");
  const fileInput = document.querySelector('input[type="file"]');
  const preview = document.getElementById('image-preview');
  const uploadArea = document.getElementById('upload-area');
  
  if (fileInput && preview && uploadArea) {
    fileInput.value = '';
    preview.classList.add('hidden');
    uploadArea.classList.remove('hidden'); // Show the upload area again
  } else {
    console.error("Missing elements for remove:", { fileInput, preview, uploadArea });
  }
}
</script>